import { expect } from "chai";
import hre, { deployments, waffle } from "hardhat";
import "@nomiclabs/hardhat-ethers";
import { deployContractHex, getSafeWithOwners , getWallets} from "../utils/setup";
import { BigNumber } from "ethers";

describe("GnosisSafe", async () => {

    const [user1] = getWallets();

    const setupTests = deployments.createFixture(async ({ deployments }) => {
        await deployments.fixture(undefined, {keepExistingDeployments: false});
        const reverterSource = `
            contract Reverter {
                function revertI() public {
                    require(false, "Shit happens");
                }
            }`
        const reverter = await deployContractHex(user1, reverterSource, '0x0061736D01000000011C0660017F006000017F60037F7F7F0060027F7F0060017F017F60000002610503656E760C6765745F6D736776616C7565000003656E760D6765745F636F64655F73697A65000103656E760F636F70795F636F64655F76616C7565000203656E760A7365745F72657475726E000303656E760B73797374656D5F68616C74000003040304050505030100020608017F01418080040B071202066D656D6F7279020005737461727400070ACE0203A60101047F418080042101024003400240200128020C0D002001280208220220004F0D020B200128020022010D000B41002101410028020821020B02402002200041076A41787122036B22024118490D00200120036A41106A22002001280200220436020002402004450D00200420003602040B2000200241706A3602082000410036020C2000200136020420012000360200200120033602080B2001410136020C200141106A0B2E004100410036028080044100410036028480044100410036028C800441003F0041107441F0FF7B6A36028880040B7501027F230041206B220024002000100002402000290300200041106A29030084200041086A290300200041186A29030084844200520D0010064100100141DE6F6A22003602880A410020001005220136028C0A200141A21020001002410041860A100341001004000B41004100100341011004000B0B8D0A010041000B860A0061736D0100000001230760017F006000017F60037F7F7F0060027F7F0060037F7F7F017F60017F017F60000002610503656E760C6765745F6D736776616C7565000003656E760D6765745F63616C6C5F73697A65000103656E760F636F70795F63616C6C5F76616C7565000203656E760A7365745F72657475726E000303656E760B73797374656D5F68616C7400000308070202020405060605030100020608017F01418080040B071202066D656D6F72790200057374617274000B0AF305072E0002402002450D000340200020012D00003A0000200041016A2100200141016A21012002417F6A22020D000B0B0B2D002001411F6A21010340200120002D00003A00002001417F6A2101200041016A21002002417F6A22020D000B0B29002001417F6A21010340200120026A20002D00003A0000200041016A21002002417F6A22020D000B0B7E01017F200120006C220141086A10092203200036020420032000360200200341086A2100024002402002417F460D002001450D010340200020022D00003A0000200041016A2100200241016A21022001417F6A22010D000C020B0B2001450D000340200041003A0000200041016A21002001417F6A22010D000B0B20030BA60101047F418080042101024003400240200128020C0D002001280208220220004F0D020B200128020022010D000B41002101410028020821020B02402002200041076A41787122036B22024118490D00200120036A41106A22002001280200220436020002402004450D00200420003602040B2000200241706A3602082000410036020C2000200136020420012000360200200120033602080B2001410136020C200141106A0B2E004100410036028080044100410036028480044100410036028C800441003F0041107441F0FF7B6A36028880040B930201057F230041306B2200240020001000024002402000290300200041106A29030084200041086A290300200041186A29030084844200520D00100A41001001220136021041002001100922023602144100200120021002200141034D0D0141002002280200220136020C2001419CA4BDD205470D01410C4101410010082202280200410020021B413F6A41607141246A220310092101200041A0F38DC600360224200041246A20014104100720004120360228200041286A200141046A4104100620002002280200410020021B220436022C2000412C6A200141246A41041006200141C4006A200241086A2004100520012003100341011004000B41004100100341011004000B41004100100341011004000B0B12010041000B0C536869742068617070656E73007D0970726F647563657273010C70726F6365737365642D62790105636C616E675D31322E302E31202868747470733A2F2F6769746875622E636F6D2F736F6C616E612D6C6162732F6C6C766D2D70726F6A65637420373437343534623061653535366461313230623961643136343561313365343863343036303161362900BD01046E616D650195010C000C6765745F6D736776616C7565010D6765745F63616C6C5F73697A65020F636F70795F63616C6C5F76616C7565030A7365745F72657475726E040B73797374656D5F68616C7405085F5F6D656D637079060B5F5F6C654E746F62653332070A5F5F6C654E746F62654E080A766563746F725F6E657709085F5F6D616C6C6F630A0B5F5F696E69745F686561700B057374617274071201000F5F5F737461636B5F706F696E746572090A0100072E726F64617461007D0970726F647563657273010C70726F6365737365642D62790105636C616E675D31322E302E31202868747470733A2F2F6769746875622E636F6D2F736F6C616E612D6C6162732F6C6C766D2D70726F6A656374203734373435346230616535353664613132306239616431363435613133653438633430363031613629008D01046E616D65016608000C6765745F6D736776616C7565010D6765745F636F64655F73697A65020F636F70795F636F64655F76616C7565030A7365745F72657475726E040B73797374656D5F68616C7405085F5F6D616C6C6F63060B5F5F696E69745F6865617007057374617274071201000F5F5F737461636B5F706F696E746572090A0100072E726F64617461');
        const decoderSource = `
            contract Decoder {
                function decode(address to, bytes memory data) public returns (bytes memory) {
                    (bool success, bytes memory data) = to.call(data);
                    require(!success, "Shit happens");
                    return data;
                }
            } `
        const decoder = await deployContractHex(user1, decoderSource, '0x0061736D01000000011C0660017F006000017F60037F7F7F0060027F7F0060017F017F60000002610503656E760C6765745F6D736776616C7565000003656E760D6765745F636F64655F73697A65000103656E760F636F70795F636F64655F76616C7565000203656E760A7365745F72657475726E000303656E760B73797374656D5F68616C74000003040304050505030100020608017F01418080040B071202066D656D6F7279020005737461727400070ACE0203A60101047F418080042101024003400240200128020C0D002001280208220220004F0D020B200128020022010D000B41002101410028020821020B02402002200041076A41787122036B22024118490D00200120036A41106A22002001280200220436020002402004450D00200420003602040B2000200241706A3602082000410036020C2000200136020420012000360200200120033602080B2001410136020C200141106A0B2E004100410036028080044100410036028480044100410036028C800441003F0041107441F0FF7B6A36028880040B7501027F230041206B220024002000100002402000290300200041106A29030084200041086A290300200041186A29030084844200520D0010064100100141896B6A22003602DC0E41002000100522013602E00E200141F71420001002410041DB0E100341001004000B41004100100341011004000B0BE20E010041000BDB0E0061736D01000000012C0860017F006000017F60037F7F7F0060057F7F7F7F7F017F60027F7F0060037F7F7F017F60017F017F60000002770603656E760C6765745F6D736776616C7565000003656E760D6765745F63616C6C5F73697A65000103656E760F636F70795F63616C6C5F76616C7565000203656E760F696E766F6B655F636F6E7472616374000303656E760A7365745F72657475726E000403656E760B73797374656D5F68616C740000030908020202020506070705030100020608017F01418080040B071202066D656D6F72790200057374617274000D0A8A0A082E0002402002450D000340200020012D00003A0000200041016A2100200141016A21012002417F6A22020D000B0B0B2D002000411F6A21000340200120002D00003A0000200141016A21012000417F6A21002002417F6A22020D000B0B2D002001411F6A21010340200120002D00003A00002001417F6A2101200041016A21002002417F6A22020D000B0B29002001417F6A21010340200120026A20002D00003A0000200041016A21002002417F6A22020D000B0B7E01017F200120006C220141086A100B2203200036020420032000360200200341086A2100024002402002417F460D002001450D010340200020022D00003A0000200041016A2100200241016A21022001417F6A22010D000C020B0B2001450D000340200041003A0000200041016A21002001417F6A22010D000B0B20030BA60101047F418080042101024003400240200128020C0D002001280208220220004F0D020B200128020022010D000B41002101410028020821020B02402002200041076A41787122036B22024118490D00200120036A41106A22002001280200220436020002402004450D00200420003602040B2000200241706A3602082000410036020C2000200136020420012000360200200120033602080B2001410136020C200141106A0B2E004100410036028080044100410036028480044100410036028C800441003F0041107441F0FF7B6A36028880040BFC0503047F067E017F230041D0016B2200240020001000024002400240024002400240024002402000290300200041106A29030084200041086A290300200041186A29030084844200520D00100C41001001220136021041002001100B22023602144100200120021002200141034D0D0141002002280200220336020C200341F8BED18D01470D012001417C6A22014120490D02200241046A2202200041206A411810072001AD2204423F580D03200041306A3502002105200041286A290300210620002903202107200241206A2000413C6A41041007200035023C220842207C22092004560D0420022008A76A200041C0006A410410072009200035024022087C2004560D062008A7410120022009A76A100A2101200041A8016A4200370300200020063703B801200020073703B001200020053E02C001200042003703A001200042003703980120004200370390012001280200210220004190016A200041F0006A41201007200041B0016A200041D8006A4114100920004200370350200041D8006A2002410020011B200141086A200041F0006A200041D0006A1003450D052000200136024441010D0741004100100441011005000B41004100100441011005000B41004100100441011005000B200041D0016A240041020F0B200041D0016A240041020F0B200041D0016A240041020F0B410C41014100100A2202280200410020021B413F6A41607141246A2203100B2101200041A0F38DC6003602C401200041C4016A200141041009200041203602C801200041C8016A200141046A4104100820002002280200410020021B220A3602CC01200041CC016A200141246A41041008200141C4006A200241086A200A100620012003100441011005000B200041D0016A240041020F0B20002802442201280200410020011B413F6A41607141206A2203100B210120004120360248200041C8006A200141041008200020002802442202280200410020021B220A36024C200041CC006A200141206A41041008200141C0006A200241086A200A100620012003100441001005000B0B12010041000B0C536869742068617070656E73007D0970726F647563657273010C70726F6365737365642D62790105636C616E675D31322E302E31202868747470733A2F2F6769746875622E636F6D2F736F6C616E612D6C6162732F6C6C766D2D70726F6A65637420373437343534623061653535366461313230623961643136343561313365343863343036303161362900DB01046E616D6501B3010E000C6765745F6D736776616C7565010D6765745F63616C6C5F73697A65020F636F70795F63616C6C5F76616C7565030F696E766F6B655F636F6E7472616374040A7365745F72657475726E050B73797374656D5F68616C7406085F5F6D656D637079070B5F5F62653332746F6C654E080B5F5F6C654E746F62653332090A5F5F6C654E746F62654E0A0A766563746F725F6E65770B085F5F6D616C6C6F630C0B5F5F696E69745F686561700D057374617274071201000F5F5F737461636B5F706F696E746572090A0100072E726F64617461007D0970726F647563657273010C70726F6365737365642D62790105636C616E675D31322E302E31202868747470733A2F2F6769746875622E636F6D2F736F6C616E612D6C6162732F6C6C766D2D70726F6A656374203734373435346230616535353664613132306239616431363435613133653438633430363031613629008D01046E616D65016608000C6765745F6D736776616C7565010D6765745F636F64655F73697A65020F636F70795F636F64655F76616C7565030A7365745F72657475726E040B73797374656D5F68616C7405085F5F6D616C6C6F63060B5F5F696E69745F6865617007057374617274071201000F5F5F737461636B5F706F696E746572090A0100072E726F64617461');
        return {
            safe: await getSafeWithOwners([user1.address]),
            reverter,
            decoder
        }
    })

    describe("requiredTxGas", async () => {

        it('should revert without reason if tx fails', async () => {
            const { safe, reverter } = await setupTests()
            const readOnlySafe = safe.connect(hre.ethers.provider)
            const data = reverter.interface.encodeFunctionData("revertI", [])
            await expect(
                readOnlySafe.callStatic.requiredTxGas(
                    reverter.address, 0, data, 0,
                    { from: safe.address }
                )
            ).to.be.revertedWith("Transaction reverted without a reason")
        })

        it('should always revert', async () => {
            const { safe } = await setupTests()
            const readOnlySafe = safe.connect(hre.ethers.provider)
            await readOnlySafe.callStatic.requiredTxGas(
                safe.address, 0, "0x", 0,
                { from: safe.address }
            ).then(() => {
                throw Error("Should never be successful")
            }, (error) => {
                const message: string = error.message
                expect(message.indexOf("Transaction reverted without a reason") < 0).to.be.true
            })
        })

        it('can be called from another contract', async () => {
            const { safe, decoder } = await setupTests()
            const data = safe.interface.encodeFunctionData("requiredTxGas", [safe.address, 0, "0x", 0])
            const result = await decoder.callStatic.decode(safe.address, data)
            expect(BigNumber.from("0x" + result.slice(result.length - 32)).toNumber()).to.be.lt(10000)
        })
    })
})